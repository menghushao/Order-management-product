<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å›ºå®šçµæ§‹ Excel Grid</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; }
    th, td {
      border: 1px solid #ccc; min-width: 60px; height: 24px; text-align: center;
    }
    th { background: #eee; position: sticky; top: 0; z-index: 2; }
    th:first-child, td:first-child {
      position: sticky; left: 0; background: #f3f3f3; z-index: 1;
    }
    td:focus { outline: 2px solid #0078D7; }
    button { margin: 10px 0; padding: 8px 16px; }
  </style>
</head>
<body>

<h3>è¡¨æ ¼è³‡æ–™åº«ï¼ˆ106 Ã— 50ï¼‰</h3>
<button onclick="save()">ğŸ’¾ å„²å­˜ï¼ˆè¦†è“‹ index.htmlï¼‰</button>
<table id="grid">
  <thead><tr id="theadRow"><th></th></tr></thead>
  <tbody id="tbody"></tbody>
</table>

<script>
const ROWS = 106, COLS = 50;
const user = 'menghushao';
const repo = 'Order-management';
const path = 'index.html';
const branch = 'main';

const theadRow = document.getElementById('theadRow');
const tbody = document.getElementById('tbody');

// ç”¢ç”Ÿè¡¨é ­
for (let c = 0; c < COLS; c++) {
  let label = '', n = c;
  while (n >= 0) {
    label = String.fromCharCode(n % 26 + 65) + label;
    n = Math.floor(n / 26) - 1;
  }
  const th = document.createElement('th');
  th.textContent = label;
  theadRow.appendChild(th);
}

// å»ºç«‹å›ºå®šè¡¨æ ¼å…§å®¹
for (let r = 0; r < ROWS; r++) {
  const tr = document.createElement('tr');
  const rowTh = document.createElement('th');
  rowTh.textContent = r + 1;
  tr.appendChild(rowTh);
  for (let c = 0; c < COLS; c++) {
    const td = document.createElement('td');
    td.contentEditable = true;
    tr.appendChild(td);
  }
  tbody.appendChild(tr);
}

// å„²å­˜åŠŸèƒ½ï¼ˆåƒ…å–æ ¼å­è³‡æ–™å¡«å…¥éœæ…‹é é¢ï¼‰
async function save() {
  const token = prompt("è«‹è¼¸å…¥ GitHub Tokenï¼ˆåƒ…é™ç•¶æ¬¡ï¼‰");
  if (!token) return;

  const values = [...tbody.rows].map(tr =>
    [...tr.cells].slice(1).map(td => td.textContent.trim())
  );

  // ç”¢å‡º JS åˆå§‹åŒ–ç‰‡æ®µ
  const dataScript = `<script>const gridData = ${JSON.stringify(values)};<\/script>`;

  // å»ºç«‹æ›´æ–°å¾Œçš„ HTML å…§å®¹ï¼ˆä¿ç•™æ•´é«”æ¨£å¼èˆ‡ç¨‹å¼ç¢¼ï¼‰
  const doc = document.documentElement.cloneNode(true);
  doc.querySelector('script')?.remove(); // ç§»é™¤èˆŠè³‡æ–™è…³æœ¬
  const newScript = document.createElement('script');
  newScript.innerHTML = `const gridData = ${JSON.stringify(values)};` +
    `for(let r=0;r<${ROWS};r++)for(let c=0;c<${COLS};c++)tbody.rows[r].cells[c+1].textContent=gridData[r][c];`;
  doc.body.appendChild(newScript);

  const html = '<!DOCTYPE html>\n' + doc.outerHTML;
  const encoded = btoa(unescape(encodeURIComponent(html)));

  // å–å¾— SHA ä¸¦ PUT æ›´æ–°
  const url = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
  const res = await fetch(`${url}?ref=${branch}`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const { sha } = await res.json();

  const update = await fetch(url, {
    method: 'PUT',
    headers: {
      Authorization: `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      message: 'æ›´æ–°æ ¼å­å…§å®¹ï¼ˆå›ºå®š 106x50ï¼‰',
      content: encoded,
      sha,
      branch
    })
  });

  alert(update.ok ? 'âœ… å·²å„²å­˜ï¼' : 'âŒ å„²å­˜å¤±æ•—');
}
</script>

<!-- å„²å­˜éçš„è¡¨æ ¼è³‡æ–™å°‡è‡ªå‹•å¯«å…¥æ­¤ script å€å¡Š -->
<script>
if (typeof gridData !== 'undefined') {
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      tbody.rows[r].cells[c + 1].textContent = gridData[r][c];
    }
  }
}
</script>

</body>
</html>
