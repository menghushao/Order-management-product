<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>èŒè™ç‡’å®˜ç¶² + é»é¤è¦†è“‹å±¤ v0.2.1</title>
  <style>
    :root {
      --bg:#0b1020;
      --panel:#121832;
      --muted:#9aa4c3;
      --text:#e7ecff;
      --brand:#5b8cff;
      --accent:#c9ff70;
      --card:#0e1430;
      --line:#1f2848;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#000}
    .site-wrap{ position:fixed; inset:0; }
    .site{ position:absolute; inset:0; width:100%; height:100%; border:0; background:#000; }
    .overlay{
      position:fixed; inset:0; pointer-events:none; z-index:50;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "Helvetica Neue", Arial;
      color:var(--text);
    }
    .stack{ position:absolute; right:14px; top:14px; display:grid; gap:10px; align-items:start; }
    .fab, .panel, .cart { pointer-events:auto; }
    .fab{
      justify-self:end;
      background: linear-gradient(180deg, #6b90ff, #3a62ff);
      color:#fff; border:0; border-radius:999px;
      padding:10px 14px; font-size:14px; cursor:pointer;
      box-shadow: 0 6px 28px rgba(60,100,255,.35);
    }
    .panel{
      position:fixed; right:-420px; top:0; height:100vh; width:400px;
      background: linear-gradient(180deg, rgba(16,22,45,.98), rgba(16,22,45,.94));
      border-left:1px solid rgba(255,255,255,.06);
      box-shadow:-10px 0 40px rgba(0,0,0,.4);
      transition:right .22s ease;
      display:grid; grid-template-rows:auto 1fr auto;
      overflow:hidden;
    }
    .panel.open{ right:0; }
    .panel-head{ padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.06); display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .panel-body{ padding:12px 14px; overflow:auto; overscroll-behavior:contain; }
    .panel-actions{ display:flex; gap:8px; padding:12px 14px; border-top:1px solid rgba(255,255,255,.06); }
    .btn{ padding:10px 14px; border-radius:12px; border:1px solid #2a355e; background:#0f1533; color:#e7ecff; cursor:pointer; }
    .btn.primary{ background: linear-gradient(180deg, #6b90ff, #3a62ff); border:none; }
    .btn.ghost{ background:transparent; }
    label{ font-size:12px; color:var(--muted); display:block; margin:0 0 4px; }
    select, input[type="number"] { width:100%; padding:8px 10px; border-radius:10px; border:1px solid #2a355e; background:#0c122d; color:#e7ecff; font-size:14px; }
    .row-2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .row-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
    .cart{
      position:fixed; right:14px; top:64px; width:320px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px; padding:12px; backdrop-filter: blur(6px) saturate(120%);
      display:grid; gap:10px; max-height: 70vh; overflow:auto;
    }
    .cart h4{ margin:0; font-size:15px; display:flex; align-items:center; justify-content:space-between; gap:6px; }
    .badge { font-size:12px; padding:2px 8px; border-radius:999px; background:rgba(91,140,255,.16); color:#bcd0ff; border:1px solid #2a3c7a; }
    .cart-empty{ color:var(--muted); font-size:13px; }
    .cart-list{ display:grid; gap:10px; }
    .cart-item{ border:1px solid var(--line); border-radius:12px; padding:10px; background:var(--card); display:grid; gap:8px; }
    .top{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .name{ font-size:14px; }
    .meta{ color:var(--muted); font-size:12px; }
    .del{ background:transparent; border:1px solid #3a4a86; color:#b7c7ff; border-radius:10px; padding:6px 8px; cursor:pointer; }
    .hint{ font-size:12px; color:#a7b3da; }
    .ver{ position:fixed; left:8px; bottom:6px; font-size:12px; color:#a7b3da; }
  </style>
</head>
<body>
  <div class="site-wrap">
    <iframe class="site" src="https://menghushao.github.io/home-page/#" title="èŒè™ç‡’å®˜ç¶²"></iframe>
  </div>

  <div class="overlay" aria-hidden="true">
    <div class="stack">
      <button id="orderFab" class="fab" title="æ‰“é–‹é»é¤é¢æ¿">ğŸ›’ é»é¤</button>
      <div id="cart" class="cart">
        <h4>è³¼ç‰©è»Š <small id="cartCount" class="badge">0</small></h4>
        <div id="cartEmpty" class="cart-empty">å°šç„¡å“é …</div>
        <div id="cartList" class="cart-list" style="display:none;"></div>
        <div class="hint">é¢æ¿é–‹å•Ÿæ™‚ï¼ŒæŠŠæ»‘é¼ ç§»åˆ°å·¦å´å³å¯æ»¾å‹•ä¸‹å±¤å®˜ç¶²ã€‚</div>
      </div>
    </div>

    <section id="orderPanel" class="panel" aria-hidden="true">
      <div class="panel-head">
        <strong>å»ºç«‹è¨‚å–®å°å¡</strong>
        <button id="closeOrder" class="btn ghost">é—œé–‰</button>
      </div>
      <div class="panel-body">
        <div class="field">
          <label for="typeSel">å“é …</label>
          <select id="typeSel"><option value="">è«‹é¸æ“‡</option></select>
        </div>
        <div class="row-2">
          <div class="field">
            <label for="qtyInput">æ•¸é‡</label>
            <input id="qtyInput" type="number" min="1" step="1" value="1" />
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <div class="hint">è³‡æ–™ä¾†æºï¼šgridData.plain.json</div>
          </div>
        </div>
        <div class="row-2">
          <div class="field">
            <label for="itemA">å•†å“A</label>
            <select id="itemA"><option value="">å•†å“A</option></select>
          </div>
          <div class="field">
            <label for="itemB">å•†å“B</label>
            <select id="itemB"><option value="">å•†å“B</option></select>
          </div>
        </div>
        <div class="field">
          <label>é™„é …ï¼ˆæœ€å¤š 6ï¼‰</label>
          <div class="row-3">
            <select class="acc"><option value="">é™„</option></select>
            <select class="acc"><option value="">é™„</option></select>
            <select class="acc"><option value="">é™„</option></select>
            <select class="acc"><option value="">é™„</option></select>
            <select class="acc"><option value="">é™„</option></select>
            <select class="acc"><option value="">é™„</option></select>
          </div>
        </div>
      </div>
      <div class="panel-actions">
        <button id="addToCartBtn" class="btn primary">åŠ å…¥è³¼ç‰©è»Š</button>
        <button id="resetOrderBtn" class="btn">æ¸…ç©º</button>
      </div>
    </section>
  </div>

  <div class="ver">v0.2.1</div>

  <script>
    const PLAIN_URL = "https://raw.githubusercontent.com/menghushao/Order-management-product/main/gridData.plain.json";

    let grid = [];
    let rows = [];
    let typeToItems = new Map();
    let itemToAccs = new Map();
    let cart = [];

    const orderFab = document.getElementById('orderFab');
    const orderPanel = document.getElementById('orderPanel');
    const closeOrder = document.getElementById('closeOrder');
    const typeSel = document.getElementById('typeSel');
    const itemASel = document.getElementById('itemA');
    const itemBSel = document.getElementById('itemB');
    const accSelects = Array.from(document.querySelectorAll('.acc'));
    const qtyInput = document.getElementById('qtyInput');
    const addToCartBtn = document.getElementById('addToCartBtn');
    const resetOrderBtn = document.getElementById('resetOrderBtn');
    const cartList = document.getElementById('cartList');
    const cartEmpty = document.getElementById('cartEmpty');
    const cartCount = document.getElementById('cartCount');

    function openPanel(){ orderPanel.classList.add('open'); orderPanel.setAttribute('aria-hidden','false'); }
    function closePanel(){ orderPanel.classList.remove('open'); orderPanel.setAttribute('aria-hidden','true'); }
    orderFab.addEventListener('click', openPanel);
    closeOrder.addEventListener('click', closePanel);

    function opt(label, value){ const o = document.createElement('option'); o.textContent = label; o.value = value ?? label; return o; }
    function uniq(arr){ return [...new Set(arr.filter(Boolean))]; }
    function is2DArray(x){ return Array.isArray(x) && x.every(r => Array.isArray(r)); }

    function normalizePlainData(data){
      // Accept shapes:
      // 1) [[...], [...]]  â† array of arrays
      // 2) { data: [[...]] }
      // 3) { grid: [[...]] } or { values: [[...]] }
      if (is2DArray(data)) return data;
      if (data && is2DArray(data.data)) return data.data;
      if (data && is2DArray(data.grid)) return data.grid;
      if (data && is2DArray(data.values)) return data.values;
      throw new Error('è³‡æ–™æ ¼å¼éŒ¯èª¤');
    }

    function buildMaps(){
      rows = grid.slice(10, 106); // 0-based: 11..106 â†’ 10..105; end index exclusive â†’ 106
      typeToItems = new Map();
      itemToAccs = new Map();

      for(const r of rows){
        const type = (r?.[0] || '').trim();
        const item = (r?.[1] || '').trim();
        if(!type || !item) continue;
        if(!typeToItems.has(type)) typeToItems.set(type, []);
        typeToItems.get(type).push(item);

        const accs = uniq((r.slice(5,15) || []).map(x => (x||'').trim()).filter(Boolean));
        if(accs.length) itemToAccs.set(item, accs);
      }
      for(const [k,v] of typeToItems.entries()) typeToItems.set(k, uniq(v));
    }

    function fillTypeSelect(){
      typeSel.innerHTML = ''; typeSel.append(opt('è«‹é¸æ“‡',''));
      [...typeToItems.keys()].forEach(t => typeSel.append(opt(t,t)));
    }
    function fillItemAB(type){
      const items = typeToItems.get(type) || [];
      const build = (sel, title) => { sel.innerHTML=''; sel.append(opt(title,'')); items.forEach(i => sel.append(opt(i,i))); };
      build(itemASel, 'å•†å“A'); build(itemBSel, 'å•†å“B');
      updateAccessoryOptions();
    }
    function updateAccessoryOptions(){
      const finalProduct = itemBSel.value || itemASel.value || '';
      const options = uniq(itemToAccs.get(finalProduct) || []);
      accSelects.forEach(sel => {
        const keep = sel.value;
        sel.innerHTML=''; sel.append(opt('é™„',''));
        options.forEach(x => sel.append(opt(x,x)));
        if(keep && options.includes(keep)) sel.value = keep;
      });
    }
    typeSel.addEventListener('change', e => fillItemAB(e.target.value));
    itemASel.addEventListener('change', updateAccessoryOptions);
    itemBSel.addEventListener('change', updateAccessoryOptions);

    function summarizeName(type,a,b,accs){
      let base='';
      if(a && b) base = [a,b].sort().join('+');
      else if(a && !b) base = (type === 'é›è›‹ç³•') ? (a + '+' + a) : a;
      else if(!a && b) base = b;
      const ext = accs.length ? '('+accs.join('+')+')' : '';
      return base + ext;
    }
    function renderCart(){
      cartCount.textContent = String(cart.length);
      if(!cart.length){ cartEmpty.style.display=''; cartList.style.display='none'; cartList.innerHTML=''; return; }
      cartEmpty.style.display='none'; cartList.style.display='grid'; cartList.innerHTML='';
      cart.forEach((it, idx) => {
        const row = document.createElement('div'); row.className='cart-item';
        const top = document.createElement('div'); top.className='top';
        const title = document.createElement('div'); title.className='name'; title.textContent = it.title + ' Ã— ' + it.qty;
        const del = document.createElement('button'); del.className='del'; del.textContent='åˆªé™¤';
        del.addEventListener('click', () => { cart.splice(idx,1); renderCart(); });
        top.append(title, del);
        const meta = document.createElement('div'); meta.className='meta';
        meta.textContent = 'å“é …ï¼š' + it.type + (it.a? 'ï¼›Aï¼š'+it.a : '') + (it.b? 'ï¼›Bï¼š'+it.b : '') + (it.accs.length? 'ï¼›é™„ï¼š'+it.accs.join('ã€') : '');
        row.append(top, meta); cartList.appendChild(row);
      });
    }
    addToCartBtn.addEventListener('click', () => {
      const type = typeSel.value.trim();
      const qty = Math.max(1, parseInt(qtyInput.value||'1',10));
      const a = itemASel.value.trim();
      const b = itemBSel.value.trim();
      if(!type || (!a && !b)){ alert('è«‹è‡³å°‘é¸æ“‡ã€Œå“é …ã€èˆ‡ã€Œå•†å“A æˆ– å•†å“Bã€å…¶ä¸€ã€‚'); return; }
      const accs = accSelects.map(s => s.value.trim()).filter(Boolean);
      const title = summarizeName(type,a,b,accs);
      cart.push({ type, qty, a, b, accs, title }); renderCart();
      itemASel.value=''; itemBSel.value=''; accSelects.forEach(s=>s.value=''); qtyInput.value=1;
    });
    resetOrderBtn.addEventListener('click', () => {
      typeSel.value=''; fillItemAB(''); accSelects.forEach(s=>s.value=''); qtyInput.value=1;
    });

    (async function init(){
      try{
        const res = await fetch(PLAIN_URL, { cache: 'no-store' });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const raw = await res.json();
        grid = normalizePlainData(raw);
        if(!is2DArray(grid)) throw new Error('è³‡æ–™æ ¼å¼éŒ¯èª¤');
        buildMaps(); fillTypeSelect();
      }catch(err){
        console.error(err);
        alert('è¼‰å…¥èœå–®è³‡æ–™å¤±æ•—ï¼š' + (err.message||''));
      }
    })();
  </script>
</body>
</html>
